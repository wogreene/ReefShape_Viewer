<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReefShape Viewer</title>
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico?">

  <!-- MapLibre -->
  <link
    href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <!-- Main stylesheet -->
  <link rel="stylesheet" href="css/style.css" />

  <!-- Inline styles: ONLY password + layout-critical rules -->
  <style>
    /* Password entry area */
    #access-panel{
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }

    #access-password{
      width: 320px;
      max-width: 85vw;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(35,35,35,0.95);
      color: #fff;
      outline: none;

      text-align: center;
      font-family: "Courier New", Courier, monospace;
      font-size: 14px;
      letter-spacing: 0.3px;
    }

    #access-password::placeholder{
      color: rgba(255,255,255,0.65);
      text-align: center;
      font-family: "Courier New", Courier, monospace;
      font-size: 14px;
    }

    /* Prevent iOS zoom-on-focus */
    @media (max-width: 768px){
      #access-password,
      #access-password::placeholder{
        font-size: 16px;
      }
    }

    #access-error{
      width: 100%;
      text-align: center;
      font-size: 0.95rem;
      color: #ffd2d2;
      min-height: 1.2em;
    }

    /* Top-right controls container */
    #top-right-controls{
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 4500;
      display: none; /* shown after password */
      align-items: center;
      gap: 8px;
    }

    /* Allow flex layout */
    #change-project-btn{
      position: static;
      display: inline-block;
    }
  </style>
</head>

<!-- View choice modal -->
<div id="view-choice-modal" style="display:none;">
  <div id="view-choice-content">
    <h2 id="view-choice-title">Victory Reef</h2>

    <div class="view-choice-buttons">
      <button id="view-2d">View 2D Orthomosaic</button>
      <button id="view-3d">View 3D Gaussian Splat</button>
    </div>

    <button id="view-cancel">Cancel</button>
  </div>
</div>

<body>
  <!-- Intro / password modal -->
  <div id="intro-modal">
    <div id="intro-content">
      <h1 id="intro-title">ReefShape Viewer</h1>
      <p id="intro-description">
        This is a web-based viewer for georeferenced, underwater
        photomosaics collected and processed using the
        <a href="https://github.com/Perry-Institute/ReefShape/">ReefShape</a> methodology.
        Each dot on the map represents a plot - click on one to zoom in and
        display imagery in 2D, or, if available, 3D using gaussian splats.
      </p>

      <div id="access-panel">
        <input
          id="access-password"
          type="text"
          placeholder="Enter project password"
          autocomplete="off"
          autocapitalize="none"
          spellcheck="false"
        />

        <button id="enter-button">Enter</button>
        <div id="access-error" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Top-right controls -->
  <div id="top-right-controls">
    <button id="help-btn" type="button" aria-label="Open help video" title="Help">?</button>
    <button id="change-project-btn" type="button">Change project</button>
  </div>

  <!-- Help video modal -->
  <div id="help-modal" aria-hidden="true" role="dialog" aria-label="Instructional video">
    <div class="help-backdrop"></div>

    <div class="help-panel" role="document">
      <button class="help-close" type="button" aria-label="Close help video">âœ•</button>

      <div class="help-content">
        <div class="help-video">
          <iframe
            src="https://www.youtube.com/embed/gx9IjP_d7vU"
            title="ReefShape instructional video"
            frameborder="0"
            allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen
          ></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Map logic -->
  <script src="js/map.js"></script>

  <!-- Page logic -->
  <script>
    (function () {
      const introModal = document.getElementById("intro-modal");
      const controls = document.getElementById("top-right-controls");
      const changeBtn = document.getElementById("change-project-btn");

      const helpBtn = document.getElementById("help-btn");
      const helpModal = document.getElementById("help-modal");
      const helpBackdrop = helpModal.querySelector(".help-backdrop");
      const helpClose = helpModal.querySelector(".help-close");
      const helpIframe = helpModal.querySelector("iframe");
      const helpSrc = helpIframe.getAttribute("src");

      function normalizePw(pw){ return (pw || "").trim(); }

      function isValidPassword(pw){
        return pw === "PIMS" || pw === "msc";
      }

      function showControls(){
        controls.style.display = "flex";
      }

      function openHelp(){
        helpModal.classList.add("is-open");
        helpModal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
      }

      function closeHelp(){
        helpModal.classList.remove("is-open");
        helpModal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        helpIframe.setAttribute("src", helpSrc); // stop playback
      }

      function submitPassword(){
        const pw = normalizePw(document.getElementById("access-password").value);
        const err = document.getElementById("access-error");

        if (!isValidPassword(pw)){
          err.textContent = "Invalid password.";
          return;
        }

        sessionStorage.setItem("reefshape_password", pw);
        introModal.style.display = "none";
        err.textContent = "";
        showControls();
      }

      document.getElementById("enter-button").onclick = submitPassword;
      document.getElementById("access-password").onkeydown = e => {
        if (e.key === "Enter") submitPassword();
      };

      changeBtn.onclick = () => {
        sessionStorage.removeItem("reefshape_password");
        location.reload();
      };

      helpBtn.onclick = openHelp;
      helpClose.onclick = closeHelp;
      helpBackdrop.onclick = closeHelp;

      document.addEventListener("keydown", e => {
        if (e.key === "Escape" && helpModal.classList.contains("is-open")) {
          closeHelp();
        }
      });

      const existing = normalizePw(sessionStorage.getItem("reefshape_password"));
      if (isValidPassword(existing)){
        introModal.style.display = "none";
        showControls();
      }
    })();
  </script>
</body>
</html>
