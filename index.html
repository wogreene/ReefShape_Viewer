<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReefShape Viewer</title>
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico?">

  <!-- MapLibre -->
  <link
    href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <link rel="stylesheet" href="css/style.css" />

  <!-- Password + splash styles -->
  <style>
    /* Password entry area */
    #access-panel{
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }

    /* Desktop default (kept at 14px) */
    #access-password{
      width: 320px;
      max-width: 85vw;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(35,35,35,0.95);
      color: #fff;
      outline: none;

      text-align: center;
      font-family: "Courier New", Courier, monospace;
      font-size: 14px;
      letter-spacing: 0.3px;
    }

    #access-password::placeholder{
      color: rgba(255,255,255,0.65);
      text-align: center;
      font-family: "Courier New", Courier, monospace;
      font-size: 14px;
    }

    /* ðŸ”‘ Mobile fix: prevent iOS zoom-on-focus */
    @media (max-width: 768px){
      #access-password{
        font-size: 16px;
      }
      #access-password::placeholder{
        font-size: 16px;
      }
    }

    #access-error{
      width: 100%;
      text-align: center;
      font-size: 0.95rem;
      color: #ffd2d2;
      min-height: 1.2em;
    }

    /* Change Project button â€” fixed so keyboard doesn't break layout */
    #change-project-btn{
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 4500;
      display: none;
    }
  </style>
</head>

<div id="view-choice-modal" style="display:none;">
  <div id="view-choice-content">
    <h2 id="view-choice-title">Victory Reef</h2>

    <div class="view-choice-buttons">
      <button id="view-2d">View 2D Orthomosaic</button>
      <button id="view-3d">View 3D Gaussian Splat</button>
    </div>

    <button id="view-cancel">Cancel</button>
  </div>
</div>

<body>
  <div id="intro-modal">
    <div id="intro-content">
      <h1 id="intro-title">ReefShape Viewer</h1>
      <p id="intro-description">
        This is a web-based viewer for georeferenced, underwater
        photomosaics collected and processed using the
        <a href="https://github.com/Perry-Institute/ReefShape/">ReefShape</a> methodology.
        Each dot on the map represents a plot - click on one to zoom in and
        display imagery in 2D, or, if available, 3D using gaussian splats. Use the dropdown to select the timepoint.
        Created by Will Greene at the Perry Institute for Marine Science / Arizona State University Center for
        Global Discovery and Conservation Science
      </p>

      <div id="access-panel">
        <input
          id="access-password"
          type="text"
          placeholder="Enter project password"
          autocomplete="off"
          autocapitalize="none"
          spellcheck="false"
        />

        <button id="enter-button">Enter</button>

        <div id="access-error" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <button id="change-project-btn">Change project</button>

  <script src="js/map.js"></script>

  <script>
  (function () {
    const introModal = document.getElementById("intro-modal");
    const changeBtn = document.getElementById("change-project-btn");

    function normalizePw(pw) {
      return (pw || "").trim();
    }

    function isValidPassword(pw) {
      const p = normalizePw(pw);
      if (!p) return false;
      if (p === "PIMS") return true;
      return p === "msc";
    }

    function showChangeProjectButton() {
      if (changeBtn) changeBtn.style.display = "inline-block";
    }

    function submitPassword() {
      const input = document.getElementById("access-password");
      const err = document.getElementById("access-error");
      const pw = normalizePw(input.value);

      if (!isValidPassword(pw)) {
        err.textContent = "Invalid password.";
        return;
      }

      sessionStorage.setItem("reefshape_password", pw);
      if (introModal) introModal.style.display = "none";
      err.textContent = "";
      showChangeProjectButton();
    }

    document.getElementById("enter-button")
      .addEventListener("click", submitPassword);

    document.getElementById("access-password")
      .addEventListener("keydown", (e) => {
        if (e.key === "Enter") submitPassword();
      });

    if (changeBtn) {
      changeBtn.addEventListener("click", () => {
        sessionStorage.removeItem("reefshape_password");
        window.location.reload();
      });
    }

    const existing = normalizePw(sessionStorage.getItem("reefshape_password"));
    if (isValidPassword(existing)) {
      if (introModal) introModal.style.display = "none";
      showChangeProjectButton();
    }
  })();
  </script>
</body>
</html>
