<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coral Reef Mosaic Viewer</title>
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico?">

  <!-- MapLibre -->
  <link
    href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <link rel="stylesheet" href="css/style.css" />

  <!-- Minimal styles for password entry (kept here so you don't have to touch style.css yet) -->
  <style>
    /* Password entry area */
    #access-panel{
      margin-top: 18px;
      display: flex;
      flex-direction: column; /* button goes below input */
      gap: 10px;
      align-items: center;
      justify-content: center;
    }

    /* Dark gray input, white text, centered, Courier, visible characters */
    #access-password{
      width: 320px;
      max-width: 85vw;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(35,35,35,0.95);
      color: #fff;
      outline: none;

      text-align: center;
      font-family: "Courier New", Courier, monospace;
      font-size: 14px;
      letter-spacing: 0.3px;
    }

    #access-password::placeholder{
      color: rgba(255,255,255,0.65);
      text-align: center;
      font-family: "Courier New", Courier, monospace;
    }

    #access-error{
      width: 100%;
      text-align: center;
      font-size: 0.95rem;
      color: #ffd2d2;
      min-height: 1.2em;
    }
  </style>
</head>

<div id="view-choice-modal" style="display:none;">
  <div id="view-choice-content">
    <h2 id="view-choice-title">Victory Reef</h2>

    <div class="view-choice-buttons">
      <button id="view-2d">View 2D Orthomosaic</button>
      <button id="view-3d">View 3D Gaussian Splat</button>
    </div>

    <button id="view-cancel">Cancel</button>
  </div>
</div>

<body>
  <div id="intro-modal">
    <div id="intro-content">
      <h1 id="intro-title">ReefShape Viewer</h1>
      <p id="intro-description">
        This is a web-based viewer for georeferenced, underwater
        photomosaics collected and processed using the
        <a href="https://github.com/Perry-Institute/ReefShape/">ReefShape</a> methodology.
        Each dot on the map represents a plot - click on one to zoom in and
        display imagery in 2D, or, if available, 3D using gaussian splats. Use the dropdown to select the timepoint.
        Created by Will Greene at the Perry Institute for Marine Science / Arizona State University Center for
        Global Discovery and Conservation Science
      </p>

      <!-- Password entry -->
      <div id="access-panel">
        <!-- NOTE: type="text" so it shows what you type (not dots) -->
        <input
          id="access-password"
          type="text"
          placeholder="Enter project password"
          autocomplete="off"
          autocapitalize="none"
          spellcheck="false"
        />

        <!-- Use your original button styling/ID -->
        <button id="enter-button">Enter</button>

        <div id="access-error" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <script src="js/map.js"></script>

  <script>
    // Password gating (client-side soft gate)
    const MASTER_PASSWORD = "PIMS";

    // For now, only one project password exists
    const PROJECT_PASSWORDS = new Set(["msc"]);

    function normalizePw(pw) {
      // Case-sensitive by default. If you want case-insensitive, use:
      // return (pw || "").trim().toLowerCase();
      return (pw || "").trim();
    }

    function isValidPassword(pw) {
      const p = normalizePw(pw);
      if (!p) return false;
      if (p === MASTER_PASSWORD) return true;
      return PROJECT_PASSWORDS.has(p);
    }

    function submitPassword() {
      const input = document.getElementById("access-password");
      const err = document.getElementById("access-error");
      const pw = normalizePw(input.value);

      if (!isValidPassword(pw)) {
        err.textContent = "Invalid password.";
        return;
      }

      // Store for map.js + viewer pages
      sessionStorage.setItem("reefshape_password", pw);

      // Close splash screen and reveal map
      document.getElementById("intro-modal").style.display = "none";
      err.textContent = "";
    }

    // Click "Enter" button
    document.getElementById("enter-button").addEventListener("click", submitPassword);

    // Press Enter in the input
    document.getElementById("access-password").addEventListener("keydown", (e) => {
      if (e.key === "Enter") submitPassword();
    });

    // Optional: If password already set this session, auto-enter
    (function autoEnterIfPasswordSet() {
      const pw = normalizePw(sessionStorage.getItem("reefshape_password"));
      if (isValidPassword(pw)) {
        document.getElementById("intro-modal").style.display = "none";
      }
    })();
  </script>
</body>
</html>
