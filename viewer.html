<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reef Viewer</title>
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico?">

  <!-- OpenLayers CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css"/>

  <!-- Viewer page CSS -->
  <link rel="stylesheet" href="css/style.css"/>

  <style>
    /* MAP */
    #map {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background: black;
    }

    /* Viewer UI (overlay) */
    .viewer-ui {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 3000;

      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;

      background: rgba(0,0,0,0.85);
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.25);

      font-size: 14px;
      color: white;

      /* helps prevent weird wrapping on narrow screens */
      max-width: calc(100vw - 24px);
      box-sizing: border-box;
    }

    .viewer-ui a.back-link {
      text-decoration: none;
      font-weight: bold;
      color: white;
      font-size: 18px;
      margin-right: 8px;
    }
    .viewer-ui a.back-link:hover {
      text-decoration: underline;
    }

    .viewer-ui button,
    .viewer-ui select {
      font-family: inherit;
      font-size: inherit;
      background: #000;
      color: #fff;
      border: 1px solid #888;
      padding: 4px 8px;
      cursor: pointer;
    }
    .viewer-ui button:hover { background: #222; }
    .viewer-ui button:active { background: #444; }

    /* Overlay toggle (hidden unless overlays exist for this reef+timepoint) */
    .overlay-toggle {
      display: none; /* shown by viewer-ol.js only when available */
      align-items: center;
      gap: 6px;
      user-select: none;
      white-space: nowrap;
    }

    .overlay-toggle input {
      cursor: pointer;
      transform: translateY(1px);
    }

    /* Mac Warning Icon inside UI */
    #macWarningIcon {
      font-size: 22px;
      cursor: pointer;
      color: #ffcc00;
      display: none; /* shown by JS */
      line-height: 1;
    }

    /* NEW: row wrapper for overlays + warning (keeps them together) */
    #overlayRow {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Mobile layout fixes:
       - Force overlayRow to become the second line (100% width)
       - Keep Overlays + Warning on the same line
       - Make the timepoint select shrink to reduce wrapping
    */
    @media (max-width: 768px) {
      /* second line */
      #overlayRow {
        flex-basis: 100%;
        width: 100%;
        margin-top: 6px;
      }

      /* keep warning at right edge of that second line */
      #macWarningIcon {
        margin-left: auto;
      }

      /* reduce select width so first row doesn't explode into extra wrap lines */
      #timepointSelect {
        max-width: 160px;
      }
    }

    /* Warning Modal */
    #macWarningModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 5000;
      display: none;
    }
    #macWarningModal .warning-box {
      background: black;
      border: 2px solid #ffcc00;
      color: white;
      padding: 20px 26px;
      border-radius: 6px;
      max-width: 420px;
      font-family: "Courier New", Courier, monospace;
    }
    #macWarningModal .warning-box h2 {
      color: #ffcc00;
      margin-bottom: 12px;
      font-size: 20px;
    }
    #macWarningModal button {
      margin-top: 16px;
      padding: 8px 18px;
      border: 1px solid #ffcc00;
      background: black;
      color: white;
      cursor: pointer;
    }
    #macWarningModal button:hover {
      background: #ffcc00;
      color: black;
    }

    /* NEW: prevent bottom overlap on mobile by moving stats box up a bit.
       viewer-ol.js will set id="coverBox" (see next file update).
    */
    @media (max-width: 768px) {
      #coverBox {
        bottom: 86px !important; /* lift above scalebar */
        right: 12px !important;
        min-width: 190px !important;
      }
    }
  </style>

  <script>
    // Gate: if user didn't come through splash / has no session password, bounce back
    (function enforcePasswordGate() {
      const pw = (sessionStorage.getItem("reefshape_password") || "").trim();
      if (!pw) {
        window.location.replace("./index.html");
      }
    })();
  </script>
</head>

<body>

  <!-- Map Container -->
  <div id="map"></div>

  <!-- UI Overlay -->
  <div class="viewer-ui">
    <a class="back-link" href="./index.html">← Back</a>

    <button id="zoomOut">−</button>
    <button id="zoomIn">+</button>

    <label for="timepointSelect">Time:</label>
    <select id="timepointSelect"></select>

    <!-- NEW: second-row wrapper so Overlays + Warning stay together -->
    <div id="overlayRow">
      <label class="overlay-toggle" id="overlayToggleWrap">
        <input type="checkbox" id="overlayToggle">
        Overlays
      </label>

      <span id="macWarningIcon">⚠️</span>
    </div>
  </div>

  <!-- Warning Modal -->
  <div id="macWarningModal">
    <div class="warning-box">
      <h2>Rendering Warning</h2>
      <p>
        This map has known rendering artifacts on macOS and iOS due to WebGL
        limitations.<br><br>
        Try panning or zooming to refresh tiles, or for better performance,
        view this page on a PC or Android device.
      </p>
      <button id="macWarningClose">Close</button>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="js/viewer-ol.js"></script>

  <script>
    // Only show icon if on Mac / iOS
    const ua = navigator.userAgent || "";
    const isMac = /Macintosh|Mac OS X/i.test(ua);
    const isIOS = /iPad|iPhone|iPod/i.test(ua);

    const macIcon = document.getElementById("macWarningIcon");
    const macModal = document.getElementById("macWarningModal");

    if (isMac || isIOS) {
      macIcon.style.display = "inline";
    }

    macIcon.onclick = () => {
      macModal.style.display = "flex";
    };

    document.getElementById("macWarningClose").onclick = () => {
      macModal.style.display = "none";
    };
  </script>

</body>
</html>
